version: '3.4'

services:
  backend:
    image: ${DOCKER_REGISTRY-}webpictweak
    build:
      context: .
      dockerfile: WebPicTweak/Dockerfile
        

  client:
    image: client
    build:
      context: ./tweaksite/
      dockerfile: Dockerfile
  
  init-dhparams:
    image: certbot/certbot
    entrypoint: /bin/sh
    command: -c 'test -f /etc/letsencrypt/ssl-dhparams.pem || openssl dhparam -out /etc/letsencrypt/ssl-dhparams.pem 4096'
    volumes:
      - /etc/letsencrypt:/etc/letsencrypt:Z

  proxy:
    image: nginx:alpine
    ports:
      - 4040:80

    depends_on:
      - client
      - backend
      - init-dhparams
    volumes:
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - acme_challenge:/usr/share/nginx/html:rw
      - react_build:/usr/share/nginx/html:ro
      - /nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    entrypoint: /bin/sh
    command: -c 'while :; do sleep 6h && wait $${!}; nginx -s reload; done & nginx -g "daemon off;"'

  certbot:
    image: certbot/certbot
    entrypoint: /bin/sh
    command: -c 'trap exit TERM; while :; do certbot renew --quiet; sleep 24h; done;'
    volumes:
      - /etc/letsencrypt:/etc/letsencrypt
      - acme_challenge:/usr/share/nginx/html:rw

volumes:
  acme_challenge: {}
  react_build: {}


